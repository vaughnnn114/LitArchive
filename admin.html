<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LitArchive Admin Dashboard</title>
    <link rel="icon" href="./images/LitArchive_Logo.png" type="image/png">
    <link rel="stylesheet" href="./css and js/admin.css">
    <style>
        /* Enhanced Admin Styles */
        body {
            font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Sidebar Styles */
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: calc(100vh - 40px);
            position: sticky;
            top: 20px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .sidebar-header img {
            width: 40px;
            height: 40px;
        }

        .sidebar-header h2 {
            margin: 0;
            color: #004d99;
            font-size: 1.2em;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            background: #004d99;
            color: white;
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .header-content h1 {
            color: #004d99;
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #004d99;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        /* Form Styles */
        .form-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #004d99;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: #004d99;
            outline: none;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Button Styles */
        .btn {
            background: #004d99;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn:hover {
            background: #003366;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        /* Category Checkboxes Styles */
        .category-checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .category-checkbox {
            display: none;
        }

        .category-checkbox + label {
            display: inline-block;
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .category-checkbox:checked + label {
            background-color: #004d99;
            color: white;
        }

        .category-checkbox + label:hover {
            background-color: #e0e0e0;
        }

        .category-checkbox:checked + label:hover {
            background-color: #003366;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            padding: 25px;
            border-radius: 10px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Loading and Messages */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                height: auto;
                position: static;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="./images/LitArchive_Logo.png" alt="Logo">
                <h2>Admin Dashboard</h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link active">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#books" class="nav-link" onclick="showSection('books')">
                        <i class="fas fa-book"></i> Books
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#users" class="nav-link" onclick="showSection('users')">
                        <i class="fas fa-users"></i> Users
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#requests" class="nav-link" onclick="showSection('requests')">
                        <i class="fas fa-bookmark"></i> Requests
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#categories" class="nav-link" onclick="showSection('categories')">
                        <i class="fas fa-tags"></i> Categories
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#reports" class="nav-link" onclick="showSection('reports')">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#history" class="nav-link" onclick="showSection('history')">
                        <i class="fas fa-history"></i> History
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#settings" class="nav-link" onclick="showSection('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header-content">
                <h1>Dashboard Overview</h1>
                <div class="user-info">
                    <span>Welcome, Admin</span>
                    <button class="btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-books">0</div>
                    <div class="stat-label">Total Books</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="active-users">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pending-requests">0</div>
                    <div class="stat-label">Pending Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="overdue-books">0</div>
                    <div class="stat-label">Overdue Books</div>
                </div>
            </div>

            <!-- Books Management Section -->
            <div class="form-section" id="books-section">
                <h2>Books Management</h2>
                <div class="search-filter">
                    <div class="search-box">
                        <input type="text" placeholder="Search books..." id="book-search">
                        <i class="fas fa-search"></i>
                    </div>
                    <select id="book-filter">
                        <option value="all">All Categories</option>
                    </select>
                </div>

                <!-- Book Selection List -->
                <label for="book-select" class="bs">Select a Book:</label>
                <select id="book-select">
                    <option value="">-- Select a Book --</option>
                </select>

                <!-- Edit Book Form -->
                <form id="edit-book-form" style="display: none;">
                    <h3>Edit Book</h3>
                    <div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" required>
                    </div>

                    <div class="form-group">
                        <label for="image">Select Image:</label>
                        <input type="file" id="image" accept="image/*">
                        <div class="image-preview-container">
                            <img id="image-preview" src="" alt="Image Preview">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea id="description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Categories:</label>
                        <div id="category-checkboxes" class="category-checkbox-container">
                            <!-- Checkboxes will be dynamically added here -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="status">Status:</label>
                        <select id="status" required>
                            <option value="Available">Available</option>
                            <option value="Checked Out">Checked Out</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="copies">Number of Copies:</label>
                        <input type="number" id="copies" min="0" value="1" required>
                    </div>

                    <div class="form-group">
                        <label for="ebook-link">eBook Link (Optional):</label>
                        <input type="url" id="ebook-link" placeholder="https://example.com/ebook">
                    </div>

                    <div class="form-group">
                        <label for="author">Author:</label>
                        <input type="text" id="author" required>
                    </div>

                    <div class="form-group">
                        <label for="isbn">ISBN:</label>
                        <input type="text" id="isbn" required>
                    </div>

                    <button type="submit" class="btn">Save Changes</button>
                    <button type="button" class="btn btn-danger" id="delete-book">Delete Book</button>
                </form>

                <!-- Add New Book Form -->
                <form id="add-book-form">
                    <h3>Add New Book</h3>
                    <div class="form-group">
                        <label for="new-title">Title:</label>
                        <input type="text" id="new-title" required>
                    </div>

                    <div class="form-group">
                        <label for="new-author">Author:</label>
                        <input type="text" id="new-author" required>
                    </div>

                    <div class="form-group">
                        <label for="new-isbn">ISBN:</label>
                        <input type="text" id="new-isbn" required>
                    </div>

                    <div class="form-group">
                        <label for="new-description">Description:</label>
                        <textarea id="new-description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="new-image">Select Image:</label>
                        <input type="file" id="new-image" accept="image/*">
                        <div class="image-preview-container">
                            <img id="new-image-preview" src="" alt="Image Preview">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Categories:</label>
                        <div id="new-category-checkboxes" class="category-checkbox-container">
                            <!-- Checkboxes will be dynamically added here -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="new-status">Status:</label>
                        <select id="new-status" required>
                            <option value="Available">Available</option>
                            <option value="Checked Out">Checked Out</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="new-copies">Number of Copies:</label>
                        <input type="number" id="new-copies" min="1" value="1" required>
                    </div>

                    <div class="form-group">
                        <label for="new-ebook-link">eBook Link (Optional):</label>
                        <input type="url" id="new-ebook-link" placeholder="https://example.com/ebook">
                    </div>

                    <button type="submit" class="btn">Add Book</button>
                </form>
            </div>

            <!-- Category Management Section -->
            <div class="form-section" id="categories-section">
                <h2>Category Management</h2>
                <div class="category-management">
                    <button type="button" class="btn" id="add-category">Add New Category</button>
                    <button type="button" class="btn btn-danger" id="delete-category">Delete Category</button>
                </div>
            </div>

            <!-- Book Requests Section -->
            <div class="form-section" id="requests-section">
                <h2>Book Requests</h2>
                <div class="search-filter">
                    <div class="search-box">
                        <input type="text" placeholder="Search requests..." id="request-search">
                        <i class="fas fa-search"></i>
                    </div>
                    <select id="request-filter">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div id="loading" class="loading"></div>
                <div class="table-container">
                    <table id="requests-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Book</th>
                                <th>Request Date</th>
                                <th>Status</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="book-requests-list">
                            <!-- Book requests will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- User Management Section -->
            <div class="form-section" id="users-section">
                <h2>User Management</h2>
                <div class="search-filter">
                    <div class="search-box">
                        <input type="text" placeholder="Search users..." id="user-search">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-list">
                            <!-- Users will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Section -->
            <div class="form-section" id="reports-section">
                <h2>Reports</h2>
                <div class="reports-grid">
                    <div class="report-card">
                        <h3>Borrowing Statistics</h3>
                        <div id="borrowing-chart"></div>
                    </div>
                    <div class="report-card">
                        <h3>Popular Categories</h3>
                        <div id="categories-chart"></div>
                    </div>
                    <div class="report-card">
                        <h3>User Activity</h3>
                        <div id="activity-chart"></div>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="form-section" id="history-section">
                <h2>Borrow/Return History</h2>
                <div class="table-container">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Book</th>
                                <th>Action</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Due Date</th>
                                <th>status</th>
                            </tr>
                        </thead>
                        <tbody id="history-list">
                            <!-- History items will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        function adminBorrowBook(title, image) {
            const user = JSON.parse(localStorage.getItem("USers")); // Ensure the user is logged in
            if (!user) {
                alert("Please log in to borrow a book.");
                return;
            }

            const borrowRequests = JSON.parse(localStorage.getItem("borrowRequests")) || [];
            const newRequest = {
                userName: user.name,
                bookTitle: title,
                status: "Pending"
            };

            borrowRequests.push(newRequest);
            localStorage.setItem("borrowRequests", JSON.stringify(borrowRequests));
            alert(`Borrow request for "${title}" has been submitted.`);
        }

        // Display the list of book requests (to show the requests in admin view)
        function displayBookRequests() {
            const bookRequestsList = document.getElementById("book-requests-list");
            const bookRequests = JSON.parse(localStorage.getItem("borrowRequests")) || [];
            const books = JSON.parse(localStorage.getItem("books")) || [];
            // Get all borrow requests for history checks
            const allRequests = bookRequests;
            // Clear the list
            bookRequestsList.innerHTML = "";
            if (bookRequests.length === 0) {
                bookRequestsList.innerHTML = "<tr><td colspan='6'>No book requests found.</td></tr>";
                return;
            }
            // Helper: check if user has overdue/damaged
            function hasBadHistory(userName) {
                return allRequests.some(r => (r.userName === userName) && (r.status === 'Overdue' || r.status === 'Damaged'));
            }
            // Helper: count user's currently approved and not overdue
            function countActiveBorrows(userName) {
                return allRequests.filter(r => r.userName === userName && r.status === 'Approved').length;
            }
            // Display each book request
            bookRequests.forEach((request, index) => {
                // Auto-approve logic
                let autoApproved = false;
                if (request.status === 'Pending') {
                    const userName = request.userName;
                    const book = books.find(b => b.title === request.bookTitle);
                    const activeBorrows = countActiveBorrows(userName);
                    const badHistory = hasBadHistory(userName);
                    const bookAvailable = book && (book.status === 'Available' || book.status === 'available') && book.copies > 0;
                    if (activeBorrows < 3 && !badHistory && bookAvailable) {
                        // Auto-approve
                        request.status = 'Approved';
                        // Set due date to user's selected returnDate if present, else 7 days from now
                        let dueDate;
                        if (request.returnDate) {
                            dueDate = new Date(request.returnDate);
                        } else {
                            dueDate = new Date();
                            dueDate.setDate(dueDate.getDate() + 7);
                        }
                        request.dueDate = dueDate.toISOString();
                        // Update book copies
                        if (book) {
                            book.copies = Math.max(0, (book.copies || 1) - 1);
                            if (book.copies === 0) book.status = 'Checked Out';
                        }
                        autoApproved = true;
                    }
                }
                const dueDate = request.dueDate ? new Date(request.dueDate).toDateString() : (request.returnDate ? new Date(request.returnDate).toDateString() : 'N/A');
                const requestDate = request.date ? new Date(request.date).toLocaleDateString() : 'N/A';
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${request.userName || 'Unknown'}</td>
                    <td>${request.bookTitle}</td>
                    <td>${requestDate}</td>
                    <td>${request.status}${autoApproved ? ' (Auto)' : ''}</td>
                    <td>${dueDate}</td>
                    <td>
                        <button onclick="approveRequest(${index})">Approve</button>
                        <button onclick="rejectRequest(${index})">Reject</button>
                    </td>
                `;
                bookRequestsList.appendChild(row);
            });
            // Save any auto-approvals and book updates
            localStorage.setItem("borrowRequests", JSON.stringify(bookRequests));
            localStorage.setItem("books", JSON.stringify(books));
        }

        // Call displayBookRequests on page load
        document.addEventListener("DOMContentLoaded", displayBookRequests);

        function approveRequest(index) {
            const borrowRequests = JSON.parse(localStorage.getItem("borrowRequests")) || [];
            const books = JSON.parse(localStorage.getItem("books")) || [];
            const adminHistory = JSON.parse(localStorage.getItem("adminHistory")) || [];
            if (borrowRequests[index]) {
                const request = borrowRequests[index];
                request.status = "Approved";
                // Set the due date to 7 days from now
                const currentDate = new Date();
                const dueDate = new Date(currentDate.setDate(currentDate.getDate() + 7));
                request.dueDate = dueDate.toISOString();
                // Find book details
                const book = books.find(b => b.title === request.bookTitle);
                // Add to adminHistory
                adminHistory.push({
                    user: request.userName || request.username || 'Unknown',
                    book: request.bookTitle || request.title || 'Unknown',
                    action: 'Approved',
                    date: new Date().toISOString(),
                    status: 'Approved',
                    dueDate: request.dueDate,
                    bookImage: book ? book.image : '',
                    bookDescription: book ? book.description : '',
                    bookCategories: book ? (book.categories || [book.category]) : [],
                });
                // Remove from borrowRequests
                borrowRequests.splice(index, 1);
                localStorage.setItem("borrowRequests", JSON.stringify(borrowRequests));
                localStorage.setItem("adminHistory", JSON.stringify(adminHistory));
                alert(`Request for "${request.bookTitle}" has been approved and moved to history.`);
                displayBookRequests();
                displayHistoryList();
            } else {
                alert("No borrow request found.");
            }
        }

        function rejectRequest(index) {
            const borrowRequests = JSON.parse(localStorage.getItem("borrowRequests")) || [];
            const books = JSON.parse(localStorage.getItem("books")) || [];
            const adminHistory = JSON.parse(localStorage.getItem("adminHistory")) || [];
            if (borrowRequests[index]) {
                const request = borrowRequests[index];
                // Find book details
                const book = books.find(b => b.title === request.bookTitle);
                // Add to adminHistory
                adminHistory.push({
                    user: request.userName || request.username || 'Unknown',
                    book: request.bookTitle || request.title || 'Unknown',
                    action: 'Rejected',
                    date: new Date().toISOString(),
                    status: 'Rejected',
                    dueDate: request.dueDate || '',
                    bookImage: book ? book.image : '',
                    bookDescription: book ? book.description : '',
                    bookCategories: book ? (book.categories || [book.category]) : [],
                });
                // Remove from borrowRequests
                borrowRequests.splice(index, 1);
                localStorage.setItem("borrowRequests", JSON.stringify(borrowRequests));
                localStorage.setItem("adminHistory", JSON.stringify(adminHistory));
                alert(`Request for "${request.bookTitle}" has been rejected and moved to history.`);
                displayBookRequests();
                displayHistoryList();
            } else {
                alert("No borrow request found.");
            }
        }

        // Load books from MySQL backend
        let books = [];
        const bookSelect = document.getElementById("book-select");
        const editForm = document.getElementById("edit-book-form");

        // Fetch books from backend and populate dropdown and update stats
        function fetchBooksAndPopulateSelect() {
            fetch('http://localhost:3001/api/books')
                .then(res => res.json())
                .then(data => {
                    books = data;
                    populateBookSelect();
                    updateDashboardStats();
                })
                .catch(err => {
                    console.error('Error loading books from MySQL:', err);
                });
        }

        // Populate the book selection dropdown
        function populateBookSelect(booksToShow = null) {
            try {
                const booksArr = booksToShow || books;
                bookSelect.innerHTML = '<option value="">-- Select a Book --</option>';
                booksArr.forEach((book) => {
                    const option = document.createElement("option");
                    option.value = book.id;
                    let categoryDisplay;
                    if (book.categories && book.categories.length > 0) {
                        categoryDisplay = book.categories.join(', ');
                    } else {
                        categoryDisplay = book.category || 'No Category';
                    }
                    option.textContent = `${book.title} (${categoryDisplay})`;
                    bookSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error populating book select:", error);
            }
        }

        // On page load, fetch books from backend
        document.addEventListener('DOMContentLoaded', fetchBooksAndPopulateSelect);

        // Update dashboard stats using books from backend
        function updateDashboardStats() {
            document.getElementById("total-books").textContent = books.length;
            // Users and requests still use localStorage for now
            const users = JSON.parse(localStorage.getItem("Users")) || {};
            const requests = JSON.parse(localStorage.getItem("borrowRequests")) || [];
            document.getElementById("active-users").textContent = Object.keys(users).length;
            document.getElementById("pending-requests").textContent = requests.filter(r => r.status === "Pending").length;
            document.getElementById("overdue-books").textContent = requests.filter(r => {
                if (r.dueDate) {
                    return new Date(r.dueDate) < new Date() && r.status === "Approved";
                }
                return false;
            }).length;
        }

        // After add or delete, always reload books and update stats
        document.getElementById("delete-book").addEventListener("click", () => {
            if (!selectedBookId) return;
            const confirmDelete = confirm("Are you sure you want to delete this book? This action cannot be undone.");
            if (confirmDelete) {
                fetch(`http://localhost:3001/api/books/${selectedBookId}`, {
                    method: 'DELETE'
                })
                .then(res => {
                    if (res.ok) {
                        alert("Book deleted successfully!");
                        fetchBooksAndPopulateSelect();
                        bookSelect.value = "";
                        selectedBookId = null;
                        editForm.style.display = "none";
                    } else {
                        alert("Failed to delete book.");
                    }
                })
                .catch(() => {
                    alert("Failed to connect to backend API.");
                });
            }
        });

        document.getElementById("add-book-form").addEventListener("submit", function(e) {
            e.preventDefault();
            const selectedCategories = getSelectedCategories("new-category-checkboxes");
            if (selectedCategories.length === 0) {
                alert("Please select at least one category for the book.");
                return;
            }
            // Get the file input
            const fileInput = document.getElementById("new-image");
            let imagePath = "./images/default-book.png";
            if (fileInput && fileInput.files && fileInput.files[0]) {
                // Use only the file name, assuming the admin has placed the file in public/images/
                imagePath = "images/" + fileInput.files[0].name;
            }
            const newBook = {
                title: document.getElementById("new-title").value,
                author: document.getElementById("new-author").value,
                isbn: document.getElementById("new-isbn").value,
                description: document.getElementById("new-description").value,
                status: document.getElementById("new-status").value,
                copies: parseInt(document.getElementById("new-copies").value) || 1,
                image: imagePath,
                categories: selectedCategories,
                category: selectedCategories[0],
                ebookLink: document.getElementById("new-ebook-link").value.trim() || null
            };
            fetch('http://localhost:3001/api/books', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newBook)
            })
            .then(res => {
                if (res.ok) {
                    alert("Book added successfully!");
                    fetchBooksAndPopulateSelect();
                    document.getElementById("add-book-form").reset();
                    document.getElementById("new-image-preview").src = "";
                } else {
                    alert("Failed to add book.");
                }
            })
            .catch(() => {
                alert("Failed to connect to backend API.");
            });
        });

        // Load categories from localStorage
        let categories = JSON.parse(localStorage.getItem("categories")) || ["it", "math", "science", "politics", "history", "language", "pe and health", "philosophy"];

        // Populate the category checkboxes for Add and Edit Book
        function populateCategorySelect() {
            try {
                const categories = JSON.parse(localStorage.getItem("categories")) || [
                    "it", "math", "science", "politics", "history", 
                    "language", "pe and health", "philosophy"
                ];
                
                // Create checkbox containers
                const categoryContainers = [
                    document.getElementById("category-checkboxes"),
                    document.getElementById("new-category-checkboxes")
                ];
                
                // Check if containers exist
                if (!categoryContainers[0] || !categoryContainers[1]) {
                    console.error("Category checkbox containers not found");
                    return;
                }
                
                categoryContainers.forEach(container => {
                    // Clear existing checkboxes
                    container.innerHTML = '';
                    
                    // Add categories as checkboxes
                    categories.forEach(category => {
                        const prefix = container.id === "category-checkboxes" ? "category" : "new-category";
                        const id = `${prefix}-${category.replace(/\s+/g, '-')}`;
                        
                        const categoryLabel = document.createElement("label");
                        categoryLabel.setAttribute("for", id);
                        categoryLabel.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                        
                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.id = id;
                        checkbox.value = category;
                        checkbox.className = "category-checkbox";
                        
                        // Create wrapper div
                        const checkboxDiv = document.createElement("div");
                        
                        // First append the hidden checkbox
                        checkboxDiv.appendChild(checkbox);
                        // Then append the label
                        checkboxDiv.appendChild(categoryLabel);
                        
                        container.appendChild(checkboxDiv);
                    });
                });
                console.log("Categories populated successfully");
            } catch (error) {
                console.error("Error populating category checkboxes:", error);
            }
        }

        // Get selected categories from checkboxes
        function getSelectedCategories(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container not found: ${containerId}`);
                return [];
            }
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            console.log(`Found ${checkboxes.length} selected categories in ${containerId}`);
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Handle book selection
        let selectedBookId = null;
        bookSelect.addEventListener("change", () => {
            selectedBookId = parseInt(bookSelect.value);
            const book = books.find(b => b.id === selectedBookId);

            if (!book) {
                editForm.style.display = "none";
                return;
            }

            // Populate the form with the selected book's data
            document.getElementById("title").value = book.title;
            document.getElementById("description").value = book.description;
            document.getElementById("status").value = book.status;
            document.getElementById("copies").value = book.copies || 1;
            document.getElementById("image-preview").src = book.image;
            document.getElementById("image-preview").style.display = "block";
            document.getElementById("ebook-link").value = book.ebookLink || "";
            document.getElementById("author").value = book.author || "";
            document.getElementById("isbn").value = book.isbn || "";
            // Handle multi-category selection
            const categoryCheckboxes = document.querySelectorAll('#category-checkboxes input[type="checkbox"]');
            categoryCheckboxes.forEach(checkbox => {
                if (book.categories && Array.isArray(book.categories)) {
                    checkbox.checked = book.categories.includes(checkbox.value);
                } else if (book.category === checkbox.value) {
                    checkbox.checked = true;
                } else {
                    checkbox.checked = false;
                }
            });
            // Show the edit form
            editForm.style.display = "block";
        });

        // Handle image input and preview for editing
        document.getElementById("image").addEventListener("change", (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = () => {
                document.getElementById("image-preview").src = reader.result;
                document.getElementById("image-preview").style.display = "block";

                if (selectedBookId !== null) {
                    books[selectedBookId].image = reader.result;
                }
            };

            if (file) {
                reader.readAsDataURL(file);
            }
        });

        // Save changes to localStorage
        document.getElementById("edit-book-form").addEventListener("submit", (e) => {
            e.preventDefault();

            if (selectedBookId === null) return;

            // Get selected categories
            const selectedCategories = getSelectedCategories("category-checkboxes");

            // Prepare the updated book data
            const updatedBook = {
                title: document.getElementById("title").value,
                author: document.getElementById("author").value,
                isbn: document.getElementById("isbn").value,
                description: document.getElementById("description").value,
                status: document.getElementById("status").value,
                copies: parseInt(document.getElementById("copies").value) || 0,
                image: document.getElementById("image-preview").src,
                categories: selectedCategories,
                category: selectedCategories.length > 0 ? selectedCategories[0] : "",
                ebookLink: document.getElementById("ebook-link").value.trim() || null
            };

            // Send PUT request to backend to update the book in MySQL
            fetch(`http://localhost:3001/api/books/${selectedBookId}` , {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedBook)
            })
            .then(res => {
                if (res.ok) {
                    alert("Book information updated successfully!");
                    fetchBooksAndPopulateSelect();
                    window.location.reload();
                } else {
                    alert("Failed to update book in database.");
                }
            })
            .catch(() => {
                alert("Failed to connect to backend API.");
            });

            // Also update localStorage for UI consistency (optional)
            const book = books[selectedBookId];
            book.title = updatedBook.title;
            book.author = updatedBook.author;
            book.isbn = updatedBook.isbn;
            book.description = updatedBook.description;
            book.status = updatedBook.status;
            book.copies = updatedBook.copies;
            book.image = updatedBook.image;
            book.categories = updatedBook.categories;
            book.category = updatedBook.category;
            book.ebookLink = updatedBook.ebookLink;
            localStorage.setItem("books", JSON.stringify(books));
        });

        // Handle adding a new category
        document.getElementById("add-category").addEventListener("click", () => {
            const newCategory = prompt("Enter the name of the new category:");
            if (newCategory) {
                // Check if category already exists
                if (categories.includes(newCategory.toLowerCase())) {
                    alert("This category already exists!");
                    return;
                }

                // Add new category
                categories.push(newCategory.toLowerCase());
                localStorage.setItem("categories", JSON.stringify(categories));

                // Update category dropdowns
                populateCategorySelect();
                alert("New category added successfully!");
            }
        });

        // Handle deleting a category
        document.getElementById("delete-category").addEventListener("click", () => {
            const categoryToDelete = prompt("Enter the name of the category to delete:");
            if (categoryToDelete) {
                const index = categories.indexOf(categoryToDelete.toLowerCase());
                if (index === -1) {
                    alert("Category not found!");
                    return;
                }

                // Check if category is in use
                const books = JSON.parse(localStorage.getItem("books")) || [];
                const booksUsingCategory = books.filter(book => {
                    // Check in categories array
                    if (book.categories && Array.isArray(book.categories)) {
                        return book.categories.includes(categoryToDelete.toLowerCase());
                    }
                    // Fallback to single category
                    return (book.category && book.category.toLowerCase() === categoryToDelete.toLowerCase()) ||
                           (book.genre && book.genre.toLowerCase() === categoryToDelete.toLowerCase());
                });

                if (booksUsingCategory.length > 0) {
                    alert("Cannot delete category: It is being used by " + booksUsingCategory.length + " book(s)!");
                    return;
                }

                // Remove category
                categories.splice(index, 1);
                localStorage.setItem("categories", JSON.stringify(categories));

                // Update category dropdowns
                populateCategorySelect();
                alert("Category deleted successfully!");
            }
        });

        // Call populateCategorySelect on page load
        document.addEventListener("DOMContentLoaded", () => {
            populateCategorySelect();
            populateBookSelect();
            updateDashboardStats();
        });

        // Assuming the categories are input by the admin
        const categoriesInput = document.getElementById("categories-input"); // Assume input field is for categories
        const saveButton = document.getElementById("save-categories");

        saveButton.addEventListener("click", () => {
            const categories = categoriesInput.value.split(',').map(category => category.trim());

            // Save categories to localStorage
            localStorage.setItem("categories", JSON.stringify(categories));
            console.log("Categories saved:", categories); // Check in the console

            alert("Categories updated successfully!");
        });

        // New Functions for Enhanced Admin Features
        function displayUsers() {
            const users = JSON.parse(localStorage.getItem("Users")) || {};
            const usersList = document.getElementById("users-list");
            usersList.innerHTML = "";

            Object.entries(users).forEach(([username, userData]) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${username}</td>
                    <td>${userData.email || 'N/A'}</td>
                    <td>${userData.role || 'User'}</td>
                    <td>${userData.status || 'Active'}</td>
                    <td>
                        <button class="btn" onclick="editUser('${username}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteUser('${username}')">Delete</button>
                    </td>
                `;
                usersList.appendChild(row);
            });
        }

        function editUser(username) {
            const users = JSON.parse(localStorage.getItem("Users")) || {};
            const userData = users[username];
            if (userData) {
                const newEmail = prompt("Enter new email:", userData.email || '');
                const newRole = prompt("Enter new role (User/Admin):", userData.role || 'User');
                const newStatus = prompt("Enter new status (Active/Inactive):", userData.status || 'Active');

                if (newEmail !== null && newRole !== null && newStatus !== null) {
                    users[username] = {
                        ...userData,
                        email: newEmail,
                        role: newRole,
                        status: newStatus
                    };
                    localStorage.setItem("Users", JSON.stringify(users));
                    displayUsers();
                    alert("User updated successfully!");
                }
            }
        }

        function deleteUser(username) {
            if (confirm(`Are you sure you want to delete user ${username}?`)) {
                const users = JSON.parse(localStorage.getItem("Users")) || {};
                delete users[username];
                localStorage.setItem("Users", JSON.stringify(users));
                displayUsers();
                alert("User deleted successfully!");
            }
        }

        function generateReports() {
            const books = JSON.parse(localStorage.getItem("books")) || [];
            const requests = JSON.parse(localStorage.getItem("borrowRequests")) || [];
            const users = JSON.parse(localStorage.getItem("Users")) || {};

            // Borrowing Statistics
            const borrowingStats = {
                total: requests.length,
                approved: requests.filter(r => r.status === "Approved").length,
                rejected: requests.filter(r => r.status === "Rejected").length,
                pending: requests.filter(r => r.status === "Pending").length
            };

            // Popular Categories
            const categoryStats = {};
            books.forEach(book => {
                const category = book.category || book.genre;
                categoryStats[category] = (categoryStats[category] || 0) + 1;
            });

            // User Activity
            const userActivity = {};
            requests.forEach(request => {
                const username = request.username;
                userActivity[username] = (userActivity[username] || 0) + 1;
            });

            // Update UI with statistics
            document.getElementById("borrowing-chart").innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${borrowingStats.total}</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${borrowingStats.approved}</div>
                    <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${borrowingStats.rejected}</div>
                    <div class="stat-label">Rejected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${borrowingStats.pending}</div>
                    <div class="stat-label">Pending</div>
                </div>
            `;

            document.getElementById("categories-chart").innerHTML = `
                <div class="category-stats">
                    ${Object.entries(categoryStats)
                        .map(([category, count]) => `
                            <div class="category-item">
                                <span>${category}</span>
                                <span>${count} books</span>
                            </div>
                        `).join('')}
                </div>
            `;

            document.getElementById("activity-chart").innerHTML = `
                <div class="user-stats">
                    ${Object.entries(userActivity)
                        .map(([username, count]) => `
                            <div class="user-item">
                                <span>${username}</span>
                                <span>${count} requests</span>
                            </div>
                        `).join('')}
                </div>
            `;
        }

        // Event Listeners
        document.getElementById("book-search").addEventListener("input", searchBooks);
        document.getElementById("book-filter").addEventListener("change", searchBooks);
        document.getElementById("request-search").addEventListener("input", displayBookRequests);
        document.getElementById("request-filter").addEventListener("change", displayBookRequests);

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page loaded, initializing..."); // Debug log
            try {
                // Make sure to call populateCategorySelect early in the initialization
                populateCategorySelect();
                populateBookSelect();
                updateDashboardStats();
                displayUsers();
                displayBookRequests();
                generateReports();
                // Verify categories checkboxes
                console.log("Edit form category checkboxes:", document.querySelectorAll('#category-checkboxes input[type="checkbox"]').length);
                console.log("Add form category checkboxes:", document.querySelectorAll('#new-category-checkboxes input[type="checkbox"]').length);
                // Update stats every minute
                setInterval(updateDashboardStats, 60000);
            } catch (error) {
                console.error("Error initializing page:", error);
            }
        });

        // Logout function
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'loginpage.html';
        }

        // Navigation Functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Get all sections
            const sections = {
                dashboard: document.querySelector('.stats-grid').parentElement,
                books: document.getElementById('books-section'),
                users: document.getElementById('users-section'),
                requests: document.getElementById('requests-section'),
                categories: document.getElementById('categories-section'),
                reports: document.getElementById('reports-section'),
                settings: document.getElementById('settings-section'),
                history: document.getElementById('history-section')
            };

            // Get all nav links
            const navLinks = document.querySelectorAll('.nav-link');

            // Function to show a specific section
            function showSection(sectionId) {
                // Hide all sections first
                Object.values(sections).forEach(section => {
                    if (section) {
                        section.style.display = 'none';
                    }
                });

                // Show the selected section
                if (sections[sectionId]) {
                    sections[sectionId].style.display = 'block';
                }

                // Update active state of nav links
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === `#${sectionId}`) {
                        link.classList.add('active');
                    }
                });

                // Update header title
                const headerTitle = document.querySelector('.header-content h1');
                if (headerTitle) {
                    headerTitle.textContent = `${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)} Management`;
                }

                // Update content based on section
                switch(sectionId) {
                    case 'dashboard':
                        updateDashboardStats();
                        break;
                    case 'books':
                        populateBookSelect();
                        break;
                    case 'users':
                        displayUsers();
                        break;
                    case 'requests':
                        displayBookRequests();
                        break;
                    case 'categories':
                        populateCategorySelect();
                        break;
                    case 'reports':
                        generateReports();
                        break;
                    case 'settings':
                        loadSettings();
                        break;
                    case 'history':
                        displayHistoryList();
                        break;
                }
            }

            // Add click event listeners to nav links
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('href').substring(1);
                    showSection(sectionId);
                });
            });

            // Initialize sections
            function initializeSections() {
                // Hide all sections except dashboard
                Object.entries(sections).forEach(([id, section]) => {
                    if (section) {
                        section.style.display = id === 'dashboard' ? 'block' : 'none';
                    }
                });

                // Set active state for dashboard link
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === '#dashboard') {
                        link.classList.add('active');
                    }
                });

                // Initialize dashboard
                updateDashboardStats();
            }

            // Call initialization
            initializeSections();

            // Ensure categories are initialized
            populateCategorySelect();

            // Add CSS for section visibility
            const style = document.createElement('style');
            style.textContent = `
                .form-section {
                    display: none;
                }
                .form-section.active {
                    display: block;
                }
                .stats-grid {
                    display: block;
                }
                .nav-link.active {
                    background: #004d99;
                    color: white;
                }
            `;
            document.head.appendChild(style);
        });

        // Add error handling for section switching
        window.addEventListener('error', function(e) {
            console.error('Error in section switching:', e);
            showSection('dashboard');
        });

        // Add hash change listener for direct navigation
        window.addEventListener('hashchange', function() {
            const sectionId = window.location.hash.substring(1);
            showSection(sectionId);
        });

        // Initialize the page with the correct section based on URL hash
        document.addEventListener('DOMContentLoaded', function() {
            const sectionId = window.location.hash.substring(1) || 'dashboard';
            showSection(sectionId);
        });

        // Function to display the history list in the admin view
        function displayHistoryList() {
            const historyList = document.getElementById("history-list");
            const adminHistory = JSON.parse(localStorage.getItem("adminHistory")) || [];
            historyList.innerHTML = "";
            if (adminHistory.length === 0) {
                historyList.innerHTML = '<tr><td colspan="7">No history found.</td></tr>';
                return;
            }
            // Sort by most recent
            adminHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            adminHistory.forEach(entry => {
                const user = entry.user;
                const book = entry.book;
                const action = entry.action;
                const date = entry.date ? new Date(entry.date).toLocaleString() : 'N/A';
                const status = entry.status || 'N/A';
                const dueDate = entry.dueDate ? new Date(entry.dueDate).toLocaleDateString() : 'N/A';
                const bookImage = entry.bookImage ? `<img src="${entry.bookImage}" alt="Book Image" style="width:40px;height:60px;object-fit:cover;">` : '';
                const bookDescription = entry.bookDescription || '';
                const bookCategories = entry.bookCategories && entry.bookCategories.length ? entry.bookCategories.join(', ') : '';
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${user}</td>
                    <td>${book}<br>${bookImage}</td>
                    <td>${action}</td>
                    <td>${date}</td>
                    <td>${status}</td>
                    <td>${dueDate}</td>
                    <td><span title="${bookDescription}">Info</span><br><small>${bookCategories}</small></td>
                `;
                historyList.appendChild(row);
            });
        }
    </script>
</body>
</html>
